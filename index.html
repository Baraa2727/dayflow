<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>TripFlow â€“ Smarte Tagesrouten</title>
    <meta name="theme-color" content="#000000" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="icon" href="/logo.png" />

    <style>
      :root { --bg:#fff; --fg:#111418; --muted:#6b7280; --ring:rgba(0,0,0,.08); }
      *{box-sizing:border-box} html,body{height:100%}
      body{margin:0;color:var(--fg);background:var(--bg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-tap-highlight-color:transparent}
      a{color:inherit;text-decoration:none} button,input,textarea{outline:none;border:0;background:transparent}
      #vercel-toolbar,[data-vercel-insights-overlay],.vercel-insights,.__vercel,[data-cka-fab],.nextjs-portal{display:none!important}

      .container{max-width:930px;margin:0 auto;padding:16px 16px 96px}
      .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 8px}
      .brand{display:flex;align-items:center;gap:10px;font-weight:800}
      .brand img{width:28px;height:28px;border-radius:50%}

      /* User-Icon ohne grauen Kreis */
      .user{width:34px;height:34px;border-radius:50%;display:grid;place-items:center;background:transparent;border:none;box-shadow:none}
      .user svg{width:18px;height:18px;stroke:#111;fill:none}

      .h1{font-size:clamp(28px,6vw,40px);line-height:1.1;margin:14px 0 4px;font-weight:900}
      .h2{color:var(--muted);margin:0 0 18px}

      /* Home input hÃ¶her, damit Placeholder-Zeilen reinpassen */
      .inputWrap{position:relative;border-radius:18px;padding:12px 56px;box-shadow:0 0 0 1px #eee inset,0 2px 12px var(--ring)}
      .inputWrap:focus-within{box-shadow:0 0 0 2px #111 inset,0 6px 20px var(--ring)}
      .prompt{width:100%;min-height:96px;resize:none;font-size:16px;line-height:1.45;color:var(--fg)}

      .iconbtn{position:absolute;top:50%;transform:translateY(-50%);width:40px;height:40px;display:grid;place-items:center;border-radius:12px}
      .iconbtn:active{transform:translateY(-50%) scale(.98)}
      .mic{left:6px} .send{right:6px}
      .iconbtn svg{width:18px;height:18px;fill:#000;stroke:#000}
      .recording svg{animation:blink .9s steps(2,end) infinite}
      @keyframes blink{50%{opacity:.25}}

      footer{text-align:center;font-size:12px;color:var(--muted);padding:28px 0}

      /* Splash (Overlay, klickt nicht ab) */
      .splash{position:fixed;inset:0;z-index:9999;background:#000;display:grid;place-items:center;animation:splashSeq 2600ms ease forwards;pointer-events:none}
      .s-inner{display:grid;place-items:center;gap:14px}
      .logo{display:grid;place-items:center}
      .logo img{width:96px;height:auto;filter:none;animation:pulse 1400ms ease-in-out infinite}
      .s-title{color:#fff;font-weight:800;letter-spacing:.3px;opacity:.9}
      @keyframes pulse{0%,100%{transform:scale(1);opacity:.95}50%{transform:scale(1.035);opacity:1}}
      @keyframes splashSeq{0%{opacity:0}15%{opacity:1}85%{opacity:1}100%{opacity:0}}

      /* Views */
      .view{display:none}
      .view.active{display:block}

      /* Chat */
      .chatWrap{height:calc(100dvh - 64px);display:flex;flex-direction:column}
      .chatBody{flex:1;overflow:auto;padding:8px 8px 96px;display:flex;flex-direction:column}
      .msg{max-width:78%;margin:8px 10px;padding:12px 14px;border-radius:14px;box-shadow:0 0 0 1px #eee inset;background:#fff}
      .me{background:#eef4ff;align-self:flex-end;box-shadow:0 0 0 1px #d6e2ff inset}
      .composer{position:fixed;left:0;right:0;bottom:0;background:#fff;padding:12px 10px calc(12px + env(safe-area-inset-bottom));box-shadow:0 -6px 24px rgba(0,0,0,.06)}
      .composer .inputWrap{max-width:930px;margin:0 auto}

      /* Bottom sheet */
      .sheet{position:fixed;left:0;right:0;bottom:-100%;background:#fff;box-shadow:0 -8px 30px rgba(0,0,0,.15);border-radius:18px 18px 0 0;padding:16px;transition:bottom .25s ease;z-index:50}
      .sheet.open{bottom:0}
      .sheet ul{list-style:none;padding:0;margin:0}
      .sheet li{padding:14px 6px;border-bottom:1px solid #eee}
      .sheet a{display:block}
    </style>
  </head>
  <body>
    <!-- Splash -->
    <div id="splash" class="splash" aria-hidden="true">
      <div class="s-inner">
        <div class="logo"><img src="/logo.png" alt="TripFlow" /></div>
        <div class="s-title">TripFlow</div>
      </div>
    </div>

    <div id="app">
      <!-- HEADER -->
      <header class="topbar">
        <a class="brand" id="homeLink" href="#/">
          <img src="/logo.png" alt="TripFlow" /><div>TripFlow</div>
        </a>
        <button id="userBtn" class="user" aria-label="Profil Ã¶ffnen">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 21a8 8 0 1 0-16 0"/><circle cx="12" cy="7" r="4"/></svg>
        </button>
      </header>

      <!-- HOME -->
      <main id="view-home" class="view active">
        <div class="container">
          <h1 class="h1">Smarte Tagesrouten</h1>
          <p class="h2">Klar, klickbar, ready.</p>

          <section class="inputWrap">
            <textarea id="prompt" class="prompt" placeholder="" rows="3"></textarea>
            <button id="micBtn" class="iconbtn mic" aria-label="Spracheingabe starten">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3z"/><path d="M19 11a7 7 0 0 1-14 0"/><path d="M12 19v3"/></svg>
            </button>
            <button id="sendBtn" class="iconbtn send" aria-label="Absenden">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22 2 11 13"/><path d="M22 2 15 22 11 13 2 9z"/></svg>
            </button>
          </section>

          <footer>Â© <span id="year"></span> TripFlow</footer>
        </div>
      </main>

      <!-- CHAT -->
      <section id="view-chat" class="view">
        <div class="chatWrap">
          <div id="chatBody" class="chatBody"></div>
          <div class="composer">
            <div class="inputWrap">
              <textarea id="chatInput" class="prompt" placeholder="Nachricht schreibenâ€¦" rows="2"></textarea>
              <button id="chatClip" class="iconbtn" style="right:52px" title="Datei anhÃ¤ngen" aria-label="Datei anhÃ¤ngen">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21.44 11.05 12 20.5a6 6 0 1 1-8.49-8.49L13 2.5a4 4 0 1 1 5.66 5.66L8.5 18.34" fill="none" stroke="#000" stroke-width="2"/></svg>
              </button>
              <button id="chatMic" class="iconbtn mic" aria-label="Spracheingabe starten">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3z"/><path d="M19 11a7 7 0 0 1-14 0"/><path d="M12 19v3"/></svg>
              </button>
              <button id="chatSend" class="iconbtn send" aria-label="Absenden">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22 2 11 13"/><path d="M22 2 15 22 11 13 2 9z"/></svg>
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- MEINE REISEN -->
      <section id="view-trips" class="view">
        <div class="container">
          <h2>Meine Reisen</h2>
          <div id="tripList"></div>
        </div>
      </section>

      <!-- Bottom Sheet -->
      <div id="sheet" class="sheet" role="dialog" aria-modal="true" aria-label="SchnellmenÃ¼">
        <ul>
          <li><a href="#/" id="newTrip">Neue Reise</a></li>
          <li><a href="#/trips" id="openTrips">Meine Reisen</a></li>
        </ul>
      </div>
    </div>

    <script>
      // Helpers
      const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
      $('#year').textContent=new Date().getFullYear();

      // Splash sicher entfernen
      const splash=$('#splash');
      splash.addEventListener('animationend',()=> splash.remove());
      setTimeout(()=>{ if($('#splash')) splash.remove(); }, 3500);

      // Bottom sheet
      const sheet=$('#sheet');
      $('#userBtn').addEventListener('click',()=> sheet.classList.toggle('open'));
      sheet.addEventListener('click',e=>{ if(e.target===sheet) sheet.classList.remove('open'); });
      $('#newTrip').addEventListener('click',()=>{ location.hash='#/'; sheet.classList.remove('open'); });
      $('#openTrips').addEventListener('click',()=> sheet.classList.remove('open'));

      // Placeholder-Rotation im Textfeld (Home)
      const PHRASES=[
        'Ich bin in Lissabon â€“ was soll ich heute machen?',
        'Erstelle eine Tagestour in Berlin bei Regen',
        'Plan mir 2 Tage in Barcelona mit Sightseeing und Restauranttipps.',
        'Mach mir eine Wochenendroute fÃ¼r Wandern im Schwarzwald'
      ];
      const promptEl=$('#prompt');
      let phTimer=null, phIdx=0;
      function startPlaceholder(){ stopPlaceholder(); function tick(){ promptEl.placeholder = PHRASES[phIdx%PHRASES.length]; phIdx++; } tick(); phTimer=setInterval(tick,3500); }
      function stopPlaceholder(){ if(phTimer){ clearInterval(phTimer); phTimer=null; } }
      promptEl.addEventListener('focus',stopPlaceholder);
      promptEl.addEventListener('input',stopPlaceholder);

      // Router
      const routes={'#/':()=>{ show('home'); promptEl.value=''; startPlaceholder(); }, '#/chat':()=>show('chat'), '#/trips':()=>{renderTrips();show('trips');}};
      function show(n){ $$('.view').forEach(v=>v.classList.remove('active')); $('#view-'+n).classList.add('active'); }
      function onRoute(){ (routes[location.hash]||routes['#/'])(); sheet.classList.remove('open'); }
      window.addEventListener('hashchange',onRoute); onRoute();
      $('#homeLink').addEventListener('click',()=>{ location.hash='#/'; });

      // Storage (Meine Reisen)
      const store={ key:'tripflow_trips', all(){ try{return JSON.parse(localStorage.getItem(this.key)||'[]');}catch{return[]} }, save(l){ localStorage.setItem(this.key,JSON.stringify(l)); }, add(t){ const l=this.all(); l.unshift(t); this.save(l); } };
      function renderTrips(){ const list=store.all(), box=$('#tripList'); if(!list.length){ box.innerHTML='<p>Noch keine Reisen â€“ starte eine neue Anfrage auf der Startseite.</p>'; return; } box.innerHTML=list.map(t=>`<div style="padding:10px 0;border-bottom:1px solid #eee"><a href="#/chat" data-id="${t.id}"><strong>${t.title}</strong><br><small>${new Date(t.created).toLocaleString()}</small></a></div>`).join(''); $$('#tripList a').forEach(a=>a.addEventListener('click',e=>{e.preventDefault();loadChat(a.getAttribute('data-id'));})); }

      // Stadt-Erkennung (Mock)
      const KNOWN_CITIES=['Berlin','Lissabon','Lisboa','Barcelona','MÃ¼nchen','Rom','Tokio','Bangkok','Schwarzwald','Hamburg','Paris','London','Wien','ZÃ¼rich'];
      function extractCity(q){ for(const c of KNOWN_CITIES){ const re=new RegExp(`\b${c}\b`,'i'); if(re.test(q)) return c; } const m=q.match(/([A-ZÃ„Ã–Ãœ][a-zÃ¤Ã¶Ã¼ÃŸ]+(?:-[A-ZÃ„Ã–Ãœ][a-zÃ¤Ã¶Ã¼ÃŸ]+)?)/); return m?m[1]:'Reise'; }

      // Chat Rendering
      let currentTripId=null;
      function appendMsg(text,me=false){ const el=document.createElement('div'); el.className='msg'+(me?' me':''); el.innerHTML=String(text).replace(/
/g,'<br>'); const body=$('#chatBody'); body.appendChild(el); body.scrollTop=body.scrollHeight; return el; }
      function newTrip(title,firstMsg){ currentTripId='t_'+Date.now(); const trip={id:currentTripId,title,created:Date.now(),messages:[{role:'user',content:firstMsg}]}; store.add(trip); renderTrips(); loadChat(currentTripId); }
      function loadChat(id){ const t=store.all().find(x=>x.id===id); if(!t){ location.hash='#/trips'; return; } currentTripId=id; $('#chatBody').innerHTML=''; t.messages.forEach(m=>appendMsg(m.content,m.role==='user')); location.hash='#/chat'; }
      function saveAssistantMessage(content){ const list=store.all(); const t=list.find(x=>x.id===currentTripId); if(!t) return; t.messages.push({role:'assistant',content}); store.save(list); }
      function saveUserMessage(content){ const list=store.all(); const t=list.find(x=>x.id===currentTripId); if(!t) return; t.messages.push({role:'user',content}); store.save(list); }

      // Mic (Home + Chat)
      let recognition,listening=false; const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
      function startMic(btn,target){ if(!SR){ alert('Spracheingabe wird nicht unterstÃ¼tzt.'); return; } if(!recognition){ recognition=new SR(); recognition.lang='de-DE'; recognition.interimResults=true; recognition.maxAlternatives=1; recognition.addEventListener('result',(e)=>{ let tx=''; for(let i=e.resultIndex;i<e.results.length;i++){ tx+=e.results[i][0].transcript; } target.value=tx.trim(); }); recognition.addEventListener('end',()=>{ listening=false; btn.classList.remove('recording'); }); }
        if(!listening){ try{ recognition.start(); listening=true; btn.classList.add('recording'); }catch(e){} } else { recognition.stop(); }
      }
      $('#micBtn').addEventListener('click',()=> startMic($('#micBtn'), promptEl));
      $('#chatMic').addEventListener('click',()=> startMic($('#chatMic'), $('#chatInput')));

      // Senden
      $('#sendBtn').addEventListener('click',async()=>{ const q=(promptEl.value.trim() || promptEl.placeholder); if(!q){ promptEl.focus(); return; } const city=extractCity(q); newTrip(city,q); await sendInChat(q); });
      $('#chatSend').addEventListener('click',async()=>{ const inp=$('#chatInput'); const q=inp.value.trim(); if(!q) return; appendMsg(q,true); saveUserMessage(q); inp.value=''; await sendInChat(q); });

      async function sendInChat(q){
        const loader=appendMsg('ðŸ§­ <i>TripFlow denktâ€¦</i>');
        const timeout = (ms)=> new Promise((_,rej)=> setTimeout(()=>rej(new Error('timeout')), ms));
        try{
          const res = await Promise.race([
            fetch('/api/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt:q})}),
            timeout(7000)
          ]);
          const data = await res.json();
          loader.remove();
          const text=((data&&(data.plan||data.text||data.content))||JSON.stringify(data))+'

<i>Bitte Ã¼berprÃ¼fe Route, Adressen und Namen â€“ die KI kann vereinzelt Fehler machen.</i>';
          appendMsg(text); saveAssistantMessage(text);
        }catch(err){
          loader.remove();
          const mock=`<b>Plan (Mock)</b><br>â€¢ A: CafÃ© zum Start<br>â€¢ B: SehenswÃ¼rdigkeit<br>â€¢ C: Mittagessen<br>â€¢ D: Spaziergang<br>â€¢ E: Aussichtspunkt<br>â€¢ F: Abendessen<br>â€¢ G: Bar â€“ Abschluss`;
          appendMsg(mock); saveAssistantMessage(mock);
        }
      }
    </script>

    <script>
      if('serviceWorker' in navigator){ window.addEventListener('load',()=>{ navigator.serviceWorker.register('/sw.js').catch(()=>{}); }); }
    </script>
  </body>
</html>
