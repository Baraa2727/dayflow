<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TripFlow – Smarte Tagesrouten</title>

  <!-- PWA / Manifest -->
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#ffffff" />

  <!-- Icons -->
  <link rel="icon" href="/logo.png" />
  <link rel="apple-touch-icon" href="/app-icon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/app-icon-180.png" />

  <!-- Tailwind & Markdown -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    html, body { height: 100%; }
    body { font-family: Inter, ui-sans-serif, -apple-system, Segoe UI, Roboto, system-ui; background:#fff; color:#111827; }
    h1, h2 { hyphens: none; } /* keine automatischen Trennstriche */

    /* sanfte Placeholder-Animation */
    .fade-in   { animation: fadeIn .45s ease-out both; }
    .fade-out  { animation: fadeOut .35s ease-in both; }
    @keyframes fadeIn  { from {opacity:0; transform:translateY(2px)} to {opacity:1; transform:translateY(0)} }
    @keyframes fadeOut { from {opacity:1; transform:translateY(0)} to {opacity:0; transform:translateY(-2px)} }

    /* Textarea ohne sichtbare Scrollbar, auto-resize */
    textarea::-webkit-scrollbar { width: 0; height: 0; }
  </style>
</head>
<body>

  <!-- Topbar -->
  <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b border-neutral-200">
    <div class="mx-auto max-w-4xl px-4 h-14 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="/logo.png" alt="TripFlow" class="w-9 h-9 rounded-full ring-1 ring-black/10 object-cover" />
        <span class="text-sm font-semibold tracking-tight">TripFlow</span>
      </div>
      <!-- nur Symbol; Funktion später -->
      <button aria-label="Benutzer & Einstellungen" class="w-9 h-9 rounded-full grid place-items-center border border-neutral-200 hover:bg-neutral-50">
        <!-- person-circle icon -->
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="12" cy="8" r="4" stroke-width="1.5"/>
          <path d="M4 20c0-4 4-6 8-6s8 2 8 6" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
  </header>

  <main class="mx-auto max-w-4xl px-4 py-8 md:py-12">
    <!-- Headline -->
    <section class="mb-6 md:mb-8">
      <h1 class="text-[28px] md:text-[34px] font-semibold leading-tight">Smarte Tagesrouten</h1>
      <p class="text-lg md:text-xl text-neutral-600">Klar, klickbar, ready.</p>
    </section>

    <!-- Chat-Block -->
    <section class="mb-8">
      <div class="relative rounded-3xl border border-neutral-200 shadow-sm bg-white p-4 md:p-5">
        <!-- animierter Suggest-Overlay -->
        <div id="suggestOverlay" class="pointer-events-none absolute left-5 right-12 top-5 text-neutral-400 select-none">
          <span id="suggestText" class="text-[15px] md:text-base fade-in"></span>
        </div>

        <!-- Textarea -->
        <textarea
          id="prompt"
          rows="3"
          class="w-full resize-none rounded-2xl border border-neutral-200 px-4 py-3 text-[15px] md:text-base outline-none focus:ring-2 focus:ring-neutral-900/10 pr-12 pl-12"
          aria-label="Deine Frage an TripFlow"
          placeholder=""
        ></textarea>

        <!-- Mikrofon links unten -->
        <button id="micBtn" title="Sprachnachricht (Speech-to-Text)"
          class="absolute left-4 bottom-4 size-10 grid place-items-center rounded-xl border border-neutral-200 hover:bg-neutral-50 active:scale-[.98] transition"
          type="button">
          <svg id="micIcon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 14a3 3 0 0 0 3-3V7a3 3 0 1 0-6 0v4a3 3 0 0 0 3 3Z"/>
            <path d="M5 11a7 7 0 0 0 14 0" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            <path d="M12 18v3" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </button>

        <!-- Senden (Pfeil) rechts unten -->
        <button id="sendBtn" title="Senden"
          class="absolute right-4 bottom-4 size-10 grid place-items-center rounded-xl bg-black text-white hover:bg-neutral-900 active:scale-[.98] transition"
          type="button">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M22 2 11 13" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="m22 2-7 20-4-9-9-4 20-7Z" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
      <p class="mt-2 text-xs text-neutral-500">Sprache: Mikro antippen – auf unterstützten Browsern wird deine Sprachnachricht als Text erkannt.</p>
    </section>

    <!-- Ausgabe -->
    <section class="rounded-2xl border border-neutral-200 shadow-sm p-4 md:p-5">
      <h2 class="text-base font-semibold">Ausgabe</h2>
      <div id="out" class="prose max-w-none mt-3">
        <p class="text-neutral-500">Frag mich z. B. nach einer Tagestour – ich liefere dir eine klare Route mit klickbaren Stopps.</p>
      </div>
    </section>

    <footer class="border-t border-neutral-200 mt-10">
      <div class="px-4 py-10 text-center text-sm text-neutral-500">
        © <span id="y"></span> TripFlow
      </div>
    </footer>
  </main>

  <script>
    document.getElementById('y').textContent = new Date().getFullYear();

    // --------- Suggest-Rotation ----------
    const samples = [
      "Ich bin in Lissabon – was soll ich heute machen?",
      "Erstelle eine Tagestour in Berlin bei Regen.",
      "Plan mir 2 Tage in Barcelona mit Sightseeing und Restauranttipps.",
      "Mach mir eine Wochenendroute für Wandern im Schwarzwald."
    ];
    const suggestOverlay = document.getElementById('suggestOverlay');
    const suggestText    = document.getElementById('suggestText');
    const promptEl       = document.getElementById('prompt');

    let suggestIdx = 0, suggestTimer = null, userInteracted = false;

    function setSuggest(text, animate=true) {
      if (!suggestOverlay) return;
      suggestText.classList.remove('fade-in','fade-out');
      if (animate) suggestText.classList.add('fade-out');
      setTimeout(() => {
        suggestText.textContent = text;
        suggestText.classList.remove('fade-out');
        if (animate) suggestText.classList.add('fade-in');
      }, animate ? 200 : 0);
    }
    function startRotation() {
      if (userInteracted) return;
      setSuggest(samples[suggestIdx], false);
      suggestTimer = setInterval(() => {
        if (userInteracted) { stopRotation(); return; }
        suggestIdx = (suggestIdx + 1) % samples.length;
        setSuggest(samples[suggestIdx], true);
      }, 2400);
    }
    function stopRotation() {
      suggestTimer && clearInterval(suggestTimer);
      suggestOverlay.style.display = 'none';
    }

    promptEl.addEventListener('focus', () => { userInteracted = true; stopRotation(); });
    promptEl.addEventListener('input', () => {
      if (promptEl.value.trim().length > 0) { userInteracted = true; stopRotation(); }
    });
    startRotation();

    // Auto-resize Textarea
    const autosize = () => { promptEl.style.height = 'auto'; promptEl.style.height = Math.min(promptEl.scrollHeight, 160) + 'px'; };
    promptEl.addEventListener('input', autosize); autosize();

    // --------- Senden / API-Aufruf ----------
    async function sendMessage() {
      const userMessage = promptEl.value.trim();
      if (!userMessage) return;
      document.getElementById('out').innerHTML = '<p class="text-neutral-500">⏳ Erzeuge Plan …</p>';
      try {
        const res = await fetch('/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userMessage })
        });
        const data = await res.json();
        if (res.ok && data.output) {
          document.getElementById('out').innerHTML = window.marked ? marked.parse(data.output) : `<pre>${data.output}</pre>`;
        } else {
          document.getElementById('out').innerHTML = `<p class="text-red-600">Fehler: ${data.error || 'Unbekannter Fehler'}</p>`;
        }
      } catch {
        document.getElementById('out').innerHTML = `<p class="text-red-600">Netzwerk-/Serverfehler.</p>`;
      }
    }
    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    promptEl.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') sendMessage();
    });

    // --------- Speech-to-Text (progressive) ----------
    const micBtn = document.getElementById('micBtn');
    const micIcon = document.getElementById('micIcon');

    let recognizing = false, recognizer = null;
    function setupRecognizer() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) return null;
      const r = new SR();
      r.lang = 'de-DE';
      r.interimResults = true;
      r.maxAlternatives = 1;
      return r;
    }
    function toggleMicNotice(show) {
      micBtn.title = show
        ? "Hört zu … tippe erneut zum Beenden"
        : "Sprachnachricht (Speech-to-Text)";
      micIcon.style.opacity = show ? 0.7 : 1;
    }

    micBtn.addEventListener('click', () => {
      if (!recognizer) recognizer = setupRecognizer();
      if (!recognizer) {
        // sanfter Hinweis
        alert('Sprachaufnahme wird von diesem Browser/Device nicht unterstützt.');
        return;
      }
      if (!recognizing) {
        // Start
        try {
          recognizer.start();
          recognizing = true;
          toggleMicNotice(true);
          userInteracted = true; stopRotation();
        } catch {}
      } else {
        // Stop
        recognizer.stop();
        recognizing = false;
        toggleMicNotice(false);
      }
    });

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      recognizer = setupRecognizer();
      if (recognizer) {
        let interim = '';
        recognizer.onresult = (e) => {
          let finalText = '';
          for (let i = e.resultIndex; i < e.results.length; i++) {
            const t = e.results[i][0].transcript;
            if (e.results[i].isFinal) finalText += t + ' ';
            else interim = t;
          }
          promptEl.value = (promptEl.value + ' ' + finalText + (interim ? ' ' + interim : '')).trim();
          autosize();
        };
        recognizer.onend = () => { recognizing = false; toggleMicNotice(false); };
        recognizer.onerror = () => { recognizing = false; toggleMicNotice(false); };
      }
    }
  </script>

  <!-- Service Worker Registrierung für PWA -->
  <script defer src="/register-sw.js"></script>
</body>
</html>
