<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>TripFlow – Smarte Tagesrouten</title>
    <meta name="theme-color" content="#000000" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="icon" href="/logo.png" />

    <style>
      :root { --bg:#fff; --fg:#111418; --muted:#6b7280; --ring:rgba(0,0,0,.08); }
      *{box-sizing:border-box} html,body{height:100%}
      /* Anti-Flicker: App unsichtbar bis Splash endet */
      body{margin:0;color:var(--fg);background:var(--bg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-tap-highlight-color:transparent}
      

      a{color:inherit;text-decoration:none} button,input,textarea{outline:none;border:0;background:transparent}
      #vercel-toolbar,[data-vercel-insights-overlay],.vercel-insights,.__vercel,[data-cka-fab],.nextjs-portal{display:none!important}

      .container{max-width:930px;margin:0 auto;padding:16px 16px 96px}
      .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 8px}
      .brand{display:flex;align-items:center;gap:10px;font-weight:800}
      .brand img{width:28px;height:28px;border-radius:50%}
      /* User-Button präzise mittig + schwarze Linien */
      .user{width:34px;height:34px;border-radius:50%;display:grid;place-items:center;box-shadow:0 0 0 1px #e5e7eb inset;background:#fff}
      .user svg{width:18px;height:18px;stroke:#111;fill:none}

      .h1{font-size:clamp(28px,6vw,40px);line-height:1.1;margin:14px 0 4px;font-weight:900}
      .h2{color:var(--muted);margin:0 0 18px}

      .inputWrap{position:relative;border-radius:18px;padding:12px 56px;box-shadow:0 0 0 1px #eee inset,0 2px 12px var(--ring)}
      .inputWrap:focus-within{box-shadow:0 0 0 2px #111 inset,0 6px 20px var(--ring)}
      .prompt{width:100%;min-height:56px;resize:none;font-size:16px;line-height:1.45;color:var(--fg)}

      .iconbtn{position:absolute;top:50%;transform:translateY(-50%);width:40px;height:40px;display:grid;place-items:center;border-radius:12px}
      .iconbtn:active{transform:translateY(-50%) scale(.98)}
      .mic{left:6px} .send{right:6px}
      .iconbtn svg{width:18px;height:18px;fill:#000;stroke:#000}
      .recording svg{animation:blink .9s steps(2,end) infinite}
      @keyframes blink{50%{opacity:.25}}

      /* Beispiele unter der Box komplett ausblenden (wir zeigen sie im Placeholder) */
      .examples{display:none}

      footer{text-align:center;font-size:12px;color:var(--muted);padding:28px 0}

      /* Splash */
      .splash{$1 pointer-events:none; }
      .s-inner{display:grid;place-items:center;gap:14px}
      .logo{display:grid;place-items:center}
      .logo img{width:96px;height:auto;filter:none;animation:pulse 1400ms ease-in-out infinite}
      .s-title{color:#fff;font-weight:800;letter-spacing:.3px;opacity:.9}
      @keyframes pulse{0%,100%{transform:scale(1);opacity:.95}50%{transform:scale(1.035);opacity:1}}
      @keyframes splashSeq{0%{opacity:0}15%{opacity:1}85%{opacity:1}100%{opacity:0}}

      .view{display:none}.view.active{display:block}
      .chatWrap{height:calc(100dvh - 64px);display:flex;flex-direction:column}
      .chatBody{flex:1;overflow:auto;padding:8px 8px 96px}
      .msg{max-width:720px;margin:12px auto;padding:14px 16px;border-radius:14px;box-shadow:0 0 0 1px #eee inset;background:#fff}
      .me{background:#111;color:#fff;box-shadow:none}
      .composer{position:fixed;left:0;right:0;bottom:0;background:#fff;padding:12px 10px calc(12px + env(safe-area-inset-bottom));box-shadow:0 -6px 24px rgba(0,0,0,.06)}
      .composer .inputWrap{max-width:930px;margin:0 auto}

      .sheet{position:fixed;left:0;right:0;bottom:-100%;background:#fff;box-shadow:0 -8px 30px rgba(0,0,0,.15);border-radius:18px 18px 0 0;padding:16px;transition:bottom .25s ease;z-index:50}
      .sheet.open{bottom:0}
      .sheet ul{list-style:none;padding:0;margin:0}
      .sheet li{padding:14px 6px;border-bottom:1px solid #eee}
      .sheet a{display:block}
    </style>
  </head>
  <body>
    <!-- Splash -->
    <div id="splash" class="splash" aria-hidden="true">
      <div class="s-inner">
        <div class="logo"><img src="/logo.png" alt="TripFlow" /></div>
        <div class="s-title">TripFlow</div>
      </div>
    </div>

    <div id="app">
      <!-- HEADER -->
      <header class="topbar">
        <a class="brand" id="homeLink" href="#/">
          <img src="/logo.png" alt="TripFlow" /><div>TripFlow</div>
        </a>
        <button id="userBtn" class="user" aria-label="Profil öffnen">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 21a8 8 0 1 0-16 0"/><circle cx="12" cy="7" r="4"/></svg>
        </button>
      </header>

      <!-- HOME -->
      <main id="view-home" class="view active">
        <div class="container">
          <h1 class="h1">Smarte Tagesrouten</h1>
          <p class="h2">Klar, klickbar, ready.</p>

          <section class="inputWrap">
            <textarea id="prompt" class="prompt" placeholder="" rows="2"></textarea>
            <button id="micBtn" class="iconbtn mic" aria-label="Spracheingabe starten">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3z"/><path d="M19 11a7 7 0 0 1-14 0"/><path d="M12 19v3"/></svg>
            </button>
            <button id="sendBtn" class="iconbtn send" aria-label="Absenden">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22 2 11 13"/><path d="M22 2 15 22 11 13 2 9z"/></svg>
            </button>
          </section>

          <!-- Beispiele unten sind entfernt -->
          <footer>© <span id="year"></span> TripFlow</footer>
        </div>
      </main>

      <!-- CHAT -->
      <section id="view-chat" class="view">
        <div class="chatWrap">
          <div id="chatBody" class="chatBody"></div>
          <div class="composer">
            <div class="inputWrap">
              <textarea id="chatInput" class="prompt" placeholder="Nachricht schreiben…" rows="2"></textarea>
              <button id="chatClip" class="iconbtn" style="right:52px" title="Datei anhängen" aria-label="Datei anhängen">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21.44 11.05 12 20.5a6 6 0 1 1-8.49-8.49L13 2.5a4 4 0 1 1 5.66 5.66L8.5 18.34" fill="none" stroke="#000" stroke-width="2"/></svg>
              </button>
              <button id="chatMic" class="iconbtn mic" aria-label="Spracheingabe starten">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3z"/><path d="M19 11a7 7 0 0 1-14 0"/><path d="M12 19v3"/></svg>
              </button>
              <button id="chatSend" class="iconbtn send" aria-label="Absenden">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22 2 11 13"/><path d="M22 2 15 22 11 13 2 9z"/></svg>
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- MEINE REISEN -->
      <section id="view-trips" class="view">
        <div class="container">
          <h2>Meine Reisen</h2>
          <div id="tripList"></div>
        </div>
      </section>

      <!-- Bottom Sheet -->
      <div id="sheet" class="sheet" role="dialog" aria-modal="true" aria-label="Schnellmenü">
        <ul>
          <li><a href="#/" id="newTrip">Neue Reise</a></li>
          <li><a href="#/trips" id="openTrips">Meine Reisen</a></li>
        </ul>
      </div>
    </div>

    <script>
      const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
      document.getElementById('year').textContent=new Date().getFullYear();

      // Splash entfernt sich nach der Animation; App ist immer sichtbar darunter
const splash=document.getElementById('splash');
splash.addEventListener('animationend',()=>{ splash.remove(); });
setTimeout(()=>{ if(document.getElementById('splash')) splash.remove(); }, 3500);

      // Bottom sheet
      const sheet=document.getElementById('sheet');
      document.getElementById('userBtn').addEventListener('click',()=> sheet.classList.toggle('open'));
      sheet.addEventListener('click',(e)=>{ if(e.target===sheet) sheet.classList.remove('open'); });
      document.getElementById('newTrip').addEventListener('click',()=>{ location.hash='#/'; sheet.classList.remove('open'); });
      document.getElementById('openTrips').addEventListener('click',()=> sheet.classList.remove('open'));

      // Placeholder-Rotation (im Textfeld, nicht darunter)
      const PHRASES=[
        'Ich bin in Lissabon – was soll ich heute machen?',
        'Erstelle eine Tagestour in Berlin bei Regen',
        'Plan mir 2 Tage in Barcelona mit Sightseeing und Restauranttipps.',
        'Mach mir eine Wochenendroute für Wandern im Schwarzwald'
      ];
      const promptEl=document.getElementById('prompt');
      let pIdx=0, pTimer=null;
      function startPlaceholderCycle(){
        stopPlaceholderCycle();
        function tick(){ promptEl.setAttribute('placeholder', PHRASES[pIdx%PHRASES.length]); pIdx++; }
        tick(); pTimer=setInterval(tick, 3500);
      }
      function stopPlaceholderCycle(){ if(pTimer){ clearInterval(pTimer); pTimer=null; } }
      // Stop, sobald der/die User:in tippt – beim Zurückkehren zur Startseite starten wir neu
      promptEl.addEventListener('focus', stopPlaceholderCycle);
      promptEl.addEventListener('input', stopPlaceholderCycle);

      // Router
      const routes={'#/':()=>{ show('home'); promptEl.value=''; startPlaceholderCycle(); }, '#/chat':()=>show('chat'), '#/trips':()=>{renderTrips(); show('trips');}};
      function show(n){ $$('.view').forEach(v=>v.classList.remove('active')); document.getElementById('view-'+n).classList.add('active'); }
      function onRoute(){ (routes[location.hash]||routes['#/'])(); sheet.classList.remove('open'); }
      window.addEventListener('hashchange',onRoute); onRoute();
      document.getElementById('homeLink').addEventListener('click',()=>{ location.hash='#/'; });

      // Storage
      const store={ key:'tripflow_trips', all(){ try{return JSON.parse(localStorage.getItem(this.key)||'[]');}catch{return[]} }, save(l){ localStorage.setItem(this.key,JSON.stringify(l)); }, add(t){ const l=this.all(); l.unshift(t); this.save(l); } };
      function renderTrips(){ const list=store.all(), box=document.getElementById('tripList'); if(!list.length){ box.innerHTML='<p>Noch keine Reisen – starte eine neue Anfrage auf der Startseite.</p>'; return; } box.innerHTML=list.map(t=>`<div style="padding:10px 0;border-bottom:1px solid #eee"><a href="#/chat" data-id="${t.id}"><strong>${t.title}</strong><br><small>${new Date(t.created).toLocaleString()}</small></a></div>`).join(''); Array.from(document.querySelectorAll('#tripList a')).forEach(a=>a.addEventListener('click',e=>{e.preventDefault();loadChat(a.getAttribute('data-id'));})); }

      // City-Extractor (Mock/Heuristik)
      const KNOWN_CITIES=['Berlin','Lissabon','Lisboa','Barcelona','München','Rom','Tokio','Bangkok','Schwarzwald','Hamburg','Paris','London','Wien','Zürich'];
      function extractCity(q){
        for(const c of KNOWN_CITIES){ const re=new RegExp(`\b${c}\b`,'i'); if(re.test(q)) return c; }
        // fallback: erstes Wort mit Großbuchstabe
        const m=q.match(/([A-ZÄÖÜ][a-zäöüß]+(?:-[A-ZÄÖÜ][a-zäöüß]+)?)/); return m?m[1]:'Reise';
      }

      // Chat Rendering
      let currentTripId=null, loadingEl=null;
      function appendMsg(text,me=false){ const el=document.createElement('div'); el.className='msg'+(me?' me':''); el.innerHTML=String(text).replace(/
/g,'<br>'); const body=document.getElementById('chatBody'); body.appendChild(el); body.scrollTop=body.scrollHeight; return el; }
      function newTrip(title,firstMsg){ currentTripId='t_'+Date.now(); const trip={id:currentTripId,title,created:Date.now(),messages:[{role:'user',content:firstMsg}]}; store.add(trip); renderTrips(); loadChat(currentTripId); }
      function loadChat(id){ const t=store.all().find(x=>x.id===id); if(!t){ location.hash='#/trips'; return; } currentTripId=id; document.getElementById('chatBody').innerHTML=''; t.messages.forEach(m=>appendMsg(m.content,m.role==='user')); location.hash='#/chat'; }
      function saveAssistantMessage(content){ const list=store.all(); const t=list.find(x=>x.id===currentTripId); if(!t) return; t.messages.push({role:'assistant',content}); store.save(list); }
      function saveUserMessage(content){ const list=store.all(); const t=list.find(x=>x.id===currentTripId); if(!t) return; t.messages.push({role:'user',content}); store.save(list); }

      // Mic (Home + Chat)
      let recognition,listening=false; const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
      function startMic(btn,target){ if(!SR) return alert('Spracheingabe wird nicht unterstützt.'); if(!recognition){ recognition=new SR(); recognition.lang='de-DE'; recognition.interimResults=true; recognition.maxAlternatives=1; recognition.addEventListener('result',(e)=>{ let tx=''; for(let i=e.resultIndex;i<e.results.length;i++){ tx+=e.results[i][0].transcript; } target.value=tx.trim(); }); recognition.addEventListener('end',()=>{ listening=false; btn.classList.remove('recording'); }); }
        if(!listening){ try{ recognition.start(); listening=true; btn.classList.add('recording'); }catch(e){} } else { recognition.stop(); }
      }
      document.getElementById('micBtn').addEventListener('click',()=> startMic(document.getElementById('micBtn'), promptEl));
      document.getElementById('chatMic').addEventListener('click',()=> startMic(document.getElementById('chatMic'), document.getElementById('chatInput')));

      // Senden
      document.getElementById('sendBtn').addEventListener('click',async()=>{ const q=promptEl.value.trim()||promptEl.getAttribute('placeholder'); if(!q){ promptEl.focus(); return; } const city=extractCity(q); newTrip(city, q); await sendInChat(q); });
      document.getElementById('chatSend').addEventListener('click',async()=>{ const inp=document.getElementById('chatInput'); const q=inp.value.trim(); if(!q) return; appendMsg(q,true); saveUserMessage(q); inp.value=''; await sendInChat(q); });

      async function sendInChat(q){
        loadingEl=appendMsg('🧭 <i>TripFlow denkt…</i>');
        try{
          const res=await fetch('/api/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt:q})});
          const data=await res.json();
          loadingEl.remove();
          const text=((data&&(data.plan||data.text||data.content))||JSON.stringify(data))+'

<i>Bitte überprüfe Route, Adressen und Namen – die KI kann vereinzelt Fehler machen.</i>';
          appendMsg(text); saveAssistantMessage(text);
        }catch(err){
          loadingEl.remove();
          const mock=`<b>Plan (Mock)</b><br>• A: Café zum Start<br>• B: Sehenswürdigkeit<br>• C: Mittagessen<br>• D: Spaziergang<br>• E: Aussichtspunkt<br>• F: Abendessen<br>• G: Bar – Abschluss`;
          appendMsg(mock); saveAssistantMessage(mock);
        }
      }

      // Clip (keine Bilder)
      (function setupNoImageAttach(btn){ if(!btn) return; const input=document.createElement('input'); input.type='file'; input.accept='.txt,.pdf,.csv,.md,.json'; input.multiple=true; input.style.display='none'; document.body.appendChild(input); btn.addEventListener('click',()=> input.click()); input.addEventListener('change',()=>{ const names=[...input.files].map(f=>f.name).join(', '); alert('Dateien angehängt: '+names+' (Bildformate sind deaktiviert)'); }); })(document.getElementById('chatClip'));
    </script>

    <script>
      if('serviceWorker' in navigator){ window.addEventListener('load',()=>{ navigator.serviceWorker.register('/sw.js').catch(()=>{}); }); }
    </script>
  </body>
</html>
